<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>🤔记一个 prefetch 疑问及分析过程 | 🌵BangKk</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="bangkk blog">
    <link rel="preload" href="/blog/assets/css/0.styles.b4e12e36.css" as="style"><link rel="preload" href="/blog/assets/js/app.6470ae5a.js" as="script"><link rel="preload" href="/blog/assets/js/2.c1c28569.js" as="script"><link rel="preload" href="/blog/assets/js/3.87ae3901.js" as="script"><link rel="prefetch" href="/blog/assets/js/4.a3e2444b.js"><link rel="prefetch" href="/blog/assets/js/5.21865d57.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.b4e12e36.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">🌵BangKk</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  博客
</a></div><div class="nav-item"><a href="/blog/tag/" class="nav-link">
  标签
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  博客
</a></div><div class="nav-item"><a href="/blog/tag/" class="nav-link">
  标签
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img src="/blog/assets/img/prefetch-logo.d520701d.jpg" alt="prefetch-logo"></p> <h2 id="prefetch-preload"><a href="#prefetch-preload" class="header-anchor">#</a> prefetch &amp; preload</h2> <p>我们知道通过 <code>&lt;link rel=“preload&quot;&gt;</code> 和 <code>&lt;link rel=“prefetch”&gt;</code>可以提前告诉浏览器如何加载我们的资源。</p> <p><code>rel=&quot;prefetch&quot;</code> 的意思是告诉浏览器这个资源我之后可能会用到，你在空闲的时候帮我下载它吧。
而 <code>rel=&quot;preload&quot;</code> 是告诉浏览器这个资源的优先级很高，浏览器会优先请求获取这个资源。</p> <h2 id="遇到的问题"><a href="#遇到的问题" class="header-anchor">#</a> 遇到的问题</h2> <p>今天后端的一个哥们找到我，说这个项目页面加载的速度太慢了，而且加载了一大堆资源。于是我们一起看了看页面的网络请求</p> <p><img src="/blog/assets/img/prefetch-network.8f401df9.png" alt="prefetch-network"></p> <p>可以看到请求中除了 <code>App</code> 必须的资源外，还包含了一大堆 <code>chunk</code> 的资源（也就是懒加载的资源）。</p> <p>因为项目是用 <code>vue-cli</code> 创建的，<code>vue-cli</code> 默认开启了资源的 <code>prefetch</code> 和 <code>preload</code> 功能，打包后生成的 <code>index.html</code> 已经插入了许多带有 <code>preXXX</code> 的 <code>link</code> 标签。</p> <p>我截取了一小段 <code>HTML</code> 文本：</p> <p><img src="/blog/assets/img/prefetch-preload-demo.2fc02982.png" alt="prefetch-preload-demo"></p> <p>可以看到这些 <code>chunk</code> 资源都被打上了 <code>prefetch</code> 标记，而必须加载的资源被打上了 <code>preload</code> 标记。</p> <h2 id="第二个问题"><a href="#第二个问题" class="header-anchor">#</a> 第二个问题</h2> <p>向大佬们解释了一下 <code>prefetch</code> 的作用后，大佬又问了我一个问题：</p> <p>“为什么 <code>prefetch</code> 下来的资源没有 <code>response data</code>，<code>HTTP Code</code> 明明是 <code>200</code>，而且跳转到其他页面之后，又去请求了这个资源，也就是同一个资源被请求了两次，是 <code>prefetch</code> 没起作用吗？”</p> <p>😅 仔细一看，确实没有 <code>response data</code>，谷歌也给出了提示 <code>Faild to load response data</code></p> <p><img src="/blog/assets/img/prefetch-response.3a68cb7a.jpg" alt="prefetch-response"></p> <h2 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h2> <p>想一想，第二个问题中的第二点其实很好回答，因为 <code>prefetch</code> 只是帮我们预先请求了一次资源，等跳转到其他页面时再次请求这个资源时，浏览器会从 <code>prefetch cache</code> 中直接读取资源，并没有真正的去请求服务端，所以虽然我们看到了两次请求，其实真正到服务端获取资源只有一次。</p> <p>可是，为什么 <code>prefetch</code> 加载的资源没有 <code>response data</code> ，通过浏览器直接访问资源的地址却是有内容的。</p> <p>这个时候我想到了 <code>prefetch</code> 的本质是提前获取未来应用可能会用到的资源，浏览器只是去下载资源，并不会去 <code>load</code> 这个资源，这里的 <code>load</code> 是指浏览器去读取这个资源，而这个动作是在这个资源真正被用到时才需要执行的，这样也就是能理解为什么 <code>Chrome</code> 给的提示是 <code>Faild to load response data</code> 了，而 <code>HTTP Code</code> 为 <code>200</code> 则表示这个资源被下载下来了。</p> <h2 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h2> <p>我们尝试跳转到另一个页面，然后看下请求的资源是什么样的（注意这里不能勾选 <code>Network</code> 中的 <code>Disable cache</code>）</p> <p><img src="/blog/assets/img/prefetch-validate.53384137.jpg" alt="prefetch-validate"></p> <p>并且这个时候浏览器才会去加载资源</p> <p><img src="/blog/assets/img/prefetch-real-response.564dea86.png" alt="prefetch-real-response"></p> <p>完！：）</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.6470ae5a.js" defer></script><script src="/blog/assets/js/2.c1c28569.js" defer></script><script src="/blog/assets/js/3.87ae3901.js" defer></script>
  </body>
</html>
